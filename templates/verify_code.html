<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Verify Pickup</title>
  </head>
  <body>
    <h1>Verify Pickup</h1>

    <p><b>Machine:</b> {{ machine_id }}</p>

    <!-- SC5: machine state display -->
    {% if machine %}
      <div style="border:1px solid #999; padding:10px; margin-bottom:10px;">
        <strong>Machine State</strong><br>
        Occupancy: {{ machine["OCCUPANCY_STATUS"] }}<br>
        Condition: {{ machine["CONDITION_STATUS"] }}<br>
        Last condition update: {{ machine["LAST_CONDITION_UPDATE"] or "N/A" }}<br>
        {% if machine["LAST_CONDITION_REASON"] %}
          Last reason: {{ machine["LAST_CONDITION_REASON"] }}<br>
        {% endif %}
      </div>

      <!-- SC5: allow report/resolve at any time (even during active session) -->
      <div style="border:1px solid #999; padding:10px; margin-bottom:10px;">
        <strong>Boarding Parent Verification Required (Condition Change)</strong><br><br>

        <form method="post" action="{{ url_for('change_machine_condition', machine_id=machine_id) }}">
          {% if machine["CONDITION_STATUS"] == "normal" %}
            <input type="hidden" name="action" value="REPORT_BROKEN">
            <button type="submit">Report Broken</button>
          {% else %}
            <input type="hidden" name="action" value="RESOLVE_ISSUE">
            <button type="submit">Resolve Issue</button>
          {% endif %}

          <br><br>

          <label>Reason (optional)</label><br>
          <input type="text" name="reason"><br><br>

          <label>Supervisor Code</label><br>
          <input type="password" name="supervisor_code" required><br><br>

          <button type="submit">Confirm Change</button>
        </form>

        <div style="margin-top:8px; font-size: 0.95em;">
          If the code is invalid, the machine condition will not change.
        </div>
      </div>
    {% endif %}

    {% if error %}
      <p style="color:red;"><b>{{ error }}</b></p>
    {% endif %}

    <form method="post" action="/machine/{{ machine_id }}/start">
      <label for="code">Verification code:</label>
      <input id="code" name="code" maxlength="6" required>
      <button type="submit">Verify</button>
    </form>

    <p><a href="/machine/{{ machine_id }}/start">Back</a></p>
  </body>
</html>
